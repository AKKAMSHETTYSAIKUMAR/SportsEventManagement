<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JwtAuthenticationController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">authorization-service</a> &gt; <a href="index.source.html" class="el_package">com.cognizant.authorization.controller</a> &gt; <span class="el_source">JwtAuthenticationController.java</span></div><h1>JwtAuthenticationController.java</h1><pre class="source lang-java linenums">package com.cognizant.authorization.controller;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.BadCredentialsException;
import org.springframework.security.authentication.DisabledException;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestHeader;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RestController;

import com.cognizant.authorization.AuthorizationServiceApplication;
import com.cognizant.authorization.model.JwtResponse;
import com.cognizant.authorization.model.MyUser;
import com.cognizant.authorization.model.UserLoginCredential;
import com.cognizant.authorization.model.UserToken;
import com.cognizant.authorization.repository.MyUserRepository;
import com.cognizant.authorization.service.CustomerDetailsService;
import com.cognizant.authorization.service.JwtUtil;

/**
 * This is the controller class for creating and validating JWT Tokens.
 */


@RestController
@CrossOrigin
<span class="nc" id="L37">public class JwtAuthenticationController {</span>
<span class="nc" id="L38">	private static final Logger log = LoggerFactory.getLogger(AuthorizationServiceApplication.class);</span>

	@Autowired
	private JwtUtil jwtutil;

	@Autowired
	private CustomerDetailsService custdetailservice;
 
	@Autowired
	private MyUserRepository userservice;

	@Autowired
	private AuthenticationManager authenticationManager;

	/**
	 * This method takes userId and Password as parameters and checks if its correct
	 * by invoking authenticate method of {@link AuthenticationManager} class and
	 * throws exception if found incorrect.
	 * 
	 * @param userid
	 * @param password
	 * @throws Exception
	 */
	private void authenticate(String userid, String password) throws Exception {
<span class="nc" id="L62">		log.info(&quot;START&quot;);</span>
<span class="nc" id="L63">		log.debug(&quot;USERID AND PASSWORD {}:&quot;, userid, password);</span>
		try {
<span class="nc" id="L65">			authenticationManager.authenticate(new UsernamePasswordAuthenticationToken(userid, password));</span>
<span class="nc" id="L66">		} catch (DisabledException e) {</span>
<span class="nc" id="L67">			log.error(&quot;EXCEPTION: NOT A VALID USER&quot;);</span>
<span class="nc" id="L68">			throw new Exception(&quot;USER DISABLED&quot;, e);</span>
<span class="nc" id="L69">		} catch (BadCredentialsException e) {</span>
<span class="nc" id="L70">			log.error(&quot;EXCEPTION: NOT A VALID USER&quot;);</span>
<span class="nc" id="L71">			throw new Exception(&quot;INVALID_CREDENTIALS&quot;, e);</span>
		}
<span class="nc" id="L73">	}</span>

	/**
	 * This method is responsible for checking whether the user credentials are
	 * correct or not by calling the authenticate method. If the user credentials
	 * are correct the token will be generated and if the credentials are wrong
	 * Exception will be thrown.Uses JwtUtil class to generate token.
	 * 
	 * @param userlogincredentials
	 * @return UserToken Class with UserId and password with token and status as OK.
	 * @throws Exception
	 */
	@RequestMapping(value = &quot;/login&quot;, method = RequestMethod.POST)
	public ResponseEntity&lt;UserToken&gt; login(@RequestBody UserLoginCredential userlogincredentials) throws Exception {
<span class="nc" id="L87">		log.info(&quot;START&quot;);</span>
<span class="nc" id="L88">		log.debug(&quot;USERLOGINCREDENTIALS {}:&quot;, userlogincredentials);</span>
<span class="nc" id="L89">		authenticate(userlogincredentials.getUserid(), userlogincredentials.getPassword());</span>
<span class="nc" id="L90">		final UserDetails userdetails = custdetailservice.loadUserByUsername(userlogincredentials.getUserid());</span>
<span class="nc" id="L91">		log.debug(&quot;USERDETAILS {}:&quot;, userdetails);</span>
<span class="nc" id="L92">		log.info(&quot;END&quot;);</span>
<span class="nc" id="L93">		return new ResponseEntity&lt;&gt;(new UserToken(userlogincredentials.getUserid(), jwtutil.generateToken(userdetails)),</span>
<span class="nc" id="L94">				HttpStatus.OK);</span>

	}

	/**
	 * This Method is responsible for validating the token provided as parameter by
	 * every request. It uses the JwtUtil class for that.
	 * 
	 * @param token
	 * @return JwtToken class and status as OK for valid token.
	 */
	@RequestMapping(value = &quot;/validate&quot;, method = RequestMethod.GET)
	public ResponseEntity&lt;?&gt; getValidity(@RequestHeader(&quot;Authorization&quot;) final String token) {
<span class="nc" id="L107">		log.debug(&quot;TOKEN {}:&quot;, token);</span>
<span class="nc" id="L108">		String newToken = token.substring(7);</span>
<span class="nc" id="L109">		log.debug(&quot;TOKEN AFTER REMOVING BEARER {}:&quot;, newToken);</span>
<span class="nc" id="L110">		JwtResponse jwtResponse = new JwtResponse();</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">		if (jwtutil.validateToken(newToken)) {</span>
<span class="nc" id="L112">			log.info(&quot;TOKEN IS VALID&quot;);</span>
<span class="nc" id="L113">			jwtResponse.setUserid(jwtutil.extractUsername(newToken));</span>
<span class="nc" id="L114">			jwtResponse.setValid(true);</span>
<span class="nc" id="L115">			jwtResponse</span>
<span class="nc" id="L116">					.setUsername((userservice.findById(jwtutil.extractUsername(newToken)).orElse(null).getUsername()));</span>
<span class="nc" id="L117">			log.debug(&quot;JWTRESPONSE {}:&quot;, jwtResponse);</span>
<span class="nc" id="L118">		} else {</span>
<span class="nc" id="L119">			log.error(&quot;TOKEN VALIDATION FAILED&quot;);</span>
<span class="nc" id="L120">			jwtResponse.setValid(false);</span>
		}
<span class="nc" id="L122">		log.info(&quot;END&quot;);</span>
<span class="nc" id="L123">		return new ResponseEntity&lt;&gt;(jwtResponse, HttpStatus.OK);</span>
	}
	
	@PostMapping(&quot;/addUser&quot;)
	public boolean addUser(@RequestBody MyUser myUser) {
<span class="nc" id="L128">		return custdetailservice.addUser(myUser);</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>